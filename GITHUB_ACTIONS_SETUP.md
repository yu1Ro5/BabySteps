# GitHub Actions iOS 自動ビルド・TestFlight配布 設定ガイド

## 概要
このワークフローは、iOSアプリの自動ビルドとTestFlightへの配布を自動化します。セマンティックバージョニングと連番ベースのビルド番号管理に対応しています。

## ワークフローの特徴

### ✅ **セマンティックバージョニング対応**
- タグベースのバージョン管理（例：`v1.2.3`）
- 手動カスタムバージョン指定も可能

### ✅ **連番ベースビルド番号管理**
- TestFlight要件に完全対応
- 重複しない一意のビルド番号
- 前回ビルド番号 + 1 の自動計算

### ✅ **完全自動化**
- タグプッシュ時の自動実行
- Info.plistの自動更新
- TestFlightへの自動アップロード
- GitHub Releaseの自動作成

## 必要な設定

### 1. GitHub Secrets の設定
以下のシークレットをGitHubリポジトリのSettings > Secrets and variables > Actions で設定してください：

- `APP_STORE_CONNECT_KEY_ID`: App Store Connect API Key ID
- `APP_STORE_CONNECT_ISSUER_ID`: App Store Connect Issuer ID  
- `APP_STORE_CONNECT_API_KEY`: App Store Connect API Key (Base64エンコードされた.p8ファイルの内容)

### 2. App Store Connect API Key の取得手順
1. [App Store Connect](https://appstoreconnect.apple.com/) にログイン
2. **統合** > **キー** に移動
3. **APIキーを生成** をクリック
4. キー名を入力し、Admin権限を付与
5. 生成されたキーID、Issuer ID、API Keyをコピー

### 3. ExportOptions.plist の設定 ✅ **完了**
チームID `58Y7Q3D4A7` が設定済みです。

### 4. プロジェクト設定の確認
- `project.yml`ファイルが正しく設定されていることを確認
- スキーム名が`BabySteps`になっていることを確認
- コード署名の設定が正しいことを確認

## ワークフローの動作

### トリガー条件
- **タグプッシュ**: `v*` パターン（例：`v1.0.0`, `v2.1.3`）
- **手動トリガー**: カスタムバージョン指定

### 実行される処理
1. コードのチェックアウト
2. XcodeGenによるプロジェクト生成
3. 前回のビルド番号取得
4. 新しいビルド番号計算（前回 + 1）
5. Info.plistの更新
6. リリースビルドの作成
7. IPAファイルのエクスポート
8. ビルド番号の保存
9. TestFlightへのアップロード
10. ビルド成果物の保存
11. GitHub Releaseの作成

### バージョン管理方式
- **バージョン番号**: セマンティック（例：1.2.3）
- **ビルド番号**: 連番ベース（例：1, 2, 3, 4...）

## 使用方法

### 1. タグベースの自動実行
```bash
# 新しいバージョンをリリース
git tag v1.2.3
git push origin v1.2.3

# ワークフローが自動実行され、TestFlightにアップロード
```

### 2. 手動トリガー
- GitHub Actionsタブから手動実行
- カスタムバージョンを入力（例：`1.5.0`）

### 3. ビルド番号の管理
- 初回実行時：ビルド番号 1
- 2回目実行時：ビルド番号 2
- 3回目実行時：ビルド番号 3
- 以降、自動的に連番で増加

## 重要なポイント

### 🔒 **TestFlight要件への対応**
- **ビルド番号の一意性**: 連番ベースで重複なし
- **バージョン管理**: セマンティックバージョニング準拠
- **自動化**: 手動操作なしでリリース完了

### 📱 **ビルド成果物**
- IPAファイル
- ビルド番号管理ファイル
- 30日間保存

### 🏷️ **タグ命名規則**
- 形式：`v{MAJOR}.{MINOR}.{PATCH}`
- 例：`v1.0.0`, `v2.1.3`, `v3.0.0`

## トラブルシューティング

### よくある問題
1. **コード署名エラー**: 証明書とプロビジョニングプロファイルの設定を確認
2. **API Key認証エラー**: App Store Connect API Keyの権限と有効性を確認
3. **ビルドエラー**: XcodeGenの設定とスキーム名を確認
4. **Git権限エラー**: ワークフローに適切なGit権限があることを確認
5. **ビルド番号重複**: 連番ベースなので発生しません

### ログの確認
GitHub Actionsの実行ログで詳細なエラー情報を確認できます。

## 注意事項
- セマンティックバージョニング版は、Gitタグとリリースを自動作成します
- ワークフローには適切なGit権限が必要です
- ビルド成果物は30日間保存されます
- 手動トリガーはGitHubのActionsタブから実行可能です
- チームID `58Y7Q3D4A7` が設定済みです
- **ビルド番号は連番ベースで管理され、TestFlight要件に完全対応しています**