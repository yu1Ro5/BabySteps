name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode
      run: |
        # åˆ©ç”¨å¯èƒ½ãªXcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
        echo "=== Available Xcode versions ==="
        ls -la /Applications/ | grep Xcode
        echo "=== Current Xcode path ==="
        xcode-select -p
        # æœ€æ–°ã®Xcodeã‚’é¸æŠ
        sudo xcode-select -switch /Applications/Xcode.app
        echo "=== Selected Xcode path ==="
        xcode-select -p
        echo "=== Xcode version ==="
        xcodebuild -version
        
    - name: Install XcodeGen
      run: |
        brew install xcodegen
        echo "=== XcodeGen version ==="
        xcodegen --version
        
    - name: List Available Simulators
      run: |
        echo "=== Available iOS Simulators ==="
        xcrun simctl list devices available | grep "iPhone"
        echo "=== Available iOS Versions ==="
        xcrun simctl list runtimes | grep "iOS"
        echo "=== Booted Simulators ==="
        xcrun simctl list devices booted
        
    - name: Generate Xcode Project
      run: |
        echo "=== Current directory ==="
        pwd
        echo "=== Directory contents ==="
        ls -la
        echo "=== Generating Xcode project ==="
        xcodegen generate
        echo "=== Generated project files ==="
        ls -la *.xcodeproj
        echo "=== Project structure ==="
        find . -name "*.xcodeproj" -exec ls -la {} \;
        
    - name: Build iOS App
      run: |
        echo "=== Building iOS App ==="
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=latest' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   build \
                   -verbose
        echo "=== Build completed ==="
        ls -la build/
                   
    - name: Run Unit Tests
      run: |
        echo "=== Running Unit Tests ==="
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=latest' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   test \
                   -only-testing:BabyStepsTests \
                   -verbose
        echo "=== Unit Tests completed ==="
                   
    - name: Run UI Tests with Screenshots
      run: |
        echo "=== Running UI Tests ==="
        # UIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=latest' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   test \
                   -only-testing:BabyStepsUITests \
                   -resultBundlePath build/UITestResults.xcresult \
                   -verbose
        
        echo "=== UI Tests completed ==="
        echo "=== Test results directory ==="
        ls -la build/
        
        # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æŠ½å‡º
        mkdir -p screenshots
        
        # ãƒ†ã‚¹ãƒˆçµæœã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã‚’è©¦è¡Œï¼‰
        echo "=== Searching for screenshots ==="
        
        # æ–¹æ³•1: ç›´æ¥çš„ãªã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ¤œç´¢
        echo "=== Method 1: Direct search ==="
        find build -name "*.png" -exec cp {} screenshots/ \; || echo "No PNG files found with method 1"
        
        # æ–¹æ³•2: xcresultã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æŠ½å‡º
        if [ -d "build/UITestResults.xcresult" ]; then
          echo "=== Method 2: Extract from xcresult ==="
          xcrun xcresulttool export --path build/UITestResults.xcresult --output-path build/extracted_results || echo "Failed to extract xcresult"
          
          # æŠ½å‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ¢ã™
          find build/extracted_results -name "*.png" -exec cp {} screenshots/ \; || echo "No PNG files found in extracted results"
        fi
        
        # æ–¹æ³•3: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
        if [ -d "$HOME/Library/Developer/Xcode/DerivedData" ]; then
          echo "=== Method 3: Search in DerivedData ==="
          find "$HOME/Library/Developer/Xcode/DerivedData" -name "*.png" -newer build/UITestResults.xcresult -exec cp {} screenshots/ \; 2>/dev/null || echo "No recent PNG files found in DerivedData"
        fi
        
        # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if [ ! "$(ls -A screenshots)" ]; then
          echo "=== No screenshots found, creating placeholder ==="
          # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã‚’ä½œæˆ
          echo "No screenshots captured during UI tests" > screenshots/README.txt
        fi
        
        echo "=== Screenshots directory contents ==="
        ls -la screenshots/
        
    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-screenshots
        path: screenshots/
        retention-days: 30
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/UITestResults.xcresult
        retention-days: 30
                   
    - name: Archive App
      run: |
        echo "=== Archiving App ==="
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'generic/platform=iOS' \
                   -derivedDataPath build \
                   -configuration Release \
                   CODE_SIGN_STYLE=Automatic \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   archive -archivePath build/BabySteps.xcarchive
        echo "=== Archive completed ==="
                   
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-artifacts
        path: build/
        retention-days: 7
        
    - name: Comment PR with Screenshots
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
          const screenshotsDir = 'screenshots';
          if (!fs.existsSync(screenshotsDir)) {
            console.log('Screenshots directory not found');
            return;
          }
          
          const files = fs.readdirSync(screenshotsDir);
          const imageFiles = files.filter(file => 
            file.endsWith('.png') || file.endsWith('.jpg') || file.endsWith('.jpeg')
          );
          
          let comment = '';
          
          if (imageFiles.length > 0) {
            comment = `## ğŸ–¼ï¸ UI Test Screenshots
            
            UIãƒ†ã‚¹ãƒˆã§æ’®å½±ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ã™ï¼š
            
            ${imageFiles.map(file => `- \`${file}\``).join('\n')}
            
            > ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ã€ŒActionsã€ã‚¿ãƒ–ã®ã€Œui-test-screenshotsã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
            
            ### ãƒ†ã‚¹ãƒˆçµæœ
            - âœ… ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ«ã€ŒBabyStepsã€ã®è¡¨ç¤ºç¢ºèª
            - âœ… ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã€ŒHello, iOS!ã€ã®è¡¨ç¤ºç¢ºèª  
            - âœ… ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºç¢ºèª
            - âœ… ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®é…ç½®ç¢ºèª
            - âœ… ç”»é¢å‘ãï¼ˆç¸¦å‘ãï¼‰ã®ç¢ºèª
            - âœ… ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¦ç´ ã®ç¢ºèª`;
          } else {
            comment = `## ğŸ“¸ UI Test Results
            
            UIãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸãŒã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯æ’®å½±ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
            
            ### ãƒ†ã‚¹ãƒˆçµæœ
            - âœ… ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ«ã€ŒBabyStepsã€ã®è¡¨ç¤ºç¢ºèª
            - âœ… ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã€ŒHello, iOS!ã€ã®è¡¨ç¤ºç¢ºèª  
            - âœ… ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºç¢ºèª
            - âœ… ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®é…ç½®ç¢ºèª
            - âœ… ç”»é¢å‘ãï¼ˆç¸¦å‘ãï¼‰ã®ç¢ºèª
            - âœ… ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¦ç´ ã®ç¢ºèª
            
            > ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®è©³ç´°ã¯ã€ŒActionsã€ã‚¿ãƒ–ã®ã€Œtest-resultsã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
          console.log('PR comment added successfully');