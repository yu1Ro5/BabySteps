name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: macos-26   # macOS 26 (Xcode 26„ÅåÂà©Áî®ÂèØËÉΩ)
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode 26.0
      run: sudo xcode-select -switch /Applications/Xcode_26.0.app

    - name: Show available SDKs
      run: xcodebuild -showsdks

    - name: List Available Simulators
      run: |
        echo "=== Available iOS Simulators ==="
        xcrun simctl list devices available
        echo "=== Available iOS Runtimes ==="
        xcrun simctl list runtimes

    - name: Install XcodeGen
      run: brew install xcodegen

    - name: Generate Xcode Project
      run: |
        xcodegen generate
        ls -la *.xcodeproj

    - name: Build iOS App (Debug)
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -sdk iphonesimulator \
                   -destination 'platform=iOS Simulator,id=A9B74785-E0A9-425D-A5F5-695BCFC1E0E7,OS=26.2,arch=arm64' \
                   -derivedDataPath build \
                   -configuration Debug \
                   ARCHS=arm64 \
                   CODE_SIGN_STYLE=Automatic \
                   CODE_SIGNING_ALLOWED=NO \
                   build \
                   -verbose

    - name: Build iOS App (Release)
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -sdk iphonesimulator \
                   -destination 'platform=iOS Simulator,id=A9B74785-E0A9-425D-A5F5-695BCFC1E0E7,OS=26.2,arch=arm64' \
                   -derivedDataPath build \
                   -configuration Release \
                   ARCHS=arm64 \
                   CODE_SIGN_STYLE=Automatic \
                   CODE_SIGNING_ALLOWED=NO \
                   build \
                   -verbose

    - name: Run Tests
      timeout-minutes: 15
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -sdk iphonesimulator \
                   -destination 'platform=iOS Simulator,id=A9B74785-E0A9-425D-A5F5-695BCFC1E0E7,OS=26.2,arch=arm64' \
                   -derivedDataPath build \
                   -configuration Debug \
                   ARCHS=arm64 \
                   CODE_SIGN_STYLE=Automatic \
                   CODE_SIGNING_ALLOWED=NO \
                   test \
                   -verbose

    - name: Archive App (unsigned)
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -sdk iphoneos26.0 \
                   -destination 'generic/platform=iOS' \
                   -derivedDataPath build \
                   -configuration Release \
                   ARCHS=arm64 \
                   CODE_SIGN_STYLE=Automatic \
                   CODE_SIGNING_ALLOWED=NO \
                   archive \
                   -archivePath build/BabySteps.xcarchive

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-artifacts
        path: build/
        retention-days: 7

    - name: Build Summary
      run: |
        echo "=== Build Summary ==="
        echo "‚úÖ Xcode Project generated successfully"
        echo "‚úÖ Debug build completed"
        echo "‚úÖ Release build completed"
        echo "‚úÖ Archive created successfully"
        echo "üì± App archived to: build/BabySteps.xcarchive"
        echo "üîß Use ios-build-testflight.yml for TestFlight releases"