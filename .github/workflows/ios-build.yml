name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode_16.4.app
      
    - name: Install XcodeGen
      run: |
        brew install xcodegen
        
    - name: List Available Simulators
      run: |
        echo "=== Available iOS Simulators ==="
        xcrun simctl list devices available | grep "iPhone"
        echo "=== Available iOS Versions ==="
        xcrun simctl list runtimes | grep "iOS"
        
    - name: Generate Xcode Project
      run: |
        xcodegen generate
        ls -la *.xcodeproj
        
    - name: Build iOS App
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.5' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   build \
                   -verbose
                   
    - name: Run Unit Tests
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.5' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   test \
                   -only-testing:BabyStepsTests \
                   -verbose
                   
    - name: Run UI Tests with Screenshots
      run: |
        # UIテストを実行してスクリーンショットを撮影
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.5' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   test \
                   -only-testing:BabyStepsUITests \
                   -resultBundlePath build/UITestResults.xcresult \
                   -verbose
        
        # スクリーンショットを抽出
        mkdir -p screenshots
        xcrun xccov view --report --files --json build/UITestResults.xcresult > build/test-report.json || true
        
        # テスト結果からスクリーンショットを取得
        find build -name "*.png" -exec cp {} screenshots/ \; || true
        
    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-screenshots
        path: screenshots/
        retention-days: 30
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/UITestResults.xcresult
        retention-days: 30
                   
    - name: Archive App
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'generic/platform=iOS' \
                   -derivedDataPath build \
                   -configuration Release \
                   CODE_SIGN_STYLE=Automatic \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   archive -archivePath build/BabySteps.xcarchive
                   
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-artifacts
        path: build/
        retention-days: 7
        
    - name: Comment PR with Screenshots
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // スクリーンショットディレクトリを確認
          const screenshotsDir = 'screenshots';
          if (!fs.existsSync(screenshotsDir)) {
            console.log('Screenshots directory not found');
            return;
          }
          
          const files = fs.readdirSync(screenshotsDir);
          const imageFiles = files.filter(file => 
            file.endsWith('.png') || file.endsWith('.jpg') || file.endsWith('.jpeg')
          );
          
          if (imageFiles.length === 0) {
            console.log('No screenshot files found');
            return;
          }
          
          // PRにコメントを追加
          const comment = `## 🖼️ UI Test Screenshots
          
          UIテストで撮影されたスクリーンショットです：
          
          ${imageFiles.map(file => `- \`${file}\``).join('\n')}
          
          > スクリーンショットは「Actions」タブの「ui-test-screenshots」アーティファクトからダウンロードできます。
          
          ### テスト結果
          - ✅ アプリタイトル「BabySteps」の表示確認
          - ✅ サブタイトル「Hello, iOS!」の表示確認  
          - ✅ チェックマークアイコンの表示確認
          - ✅ 画面レイアウトの配置確認
          - ✅ 画面向き（縦向き）の確認
          - ✅ アクセシビリティ要素の確認`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
          console.log('PR comment added successfully');