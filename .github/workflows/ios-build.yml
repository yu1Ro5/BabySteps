name: iOS Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode_16.4.app
      
    - name: Install XcodeGen
      run: |
        brew install xcodegen
        
    - name: List Available Simulators
      run: |
        echo "=== Available iOS Simulators ==="
        xcrun simctl list devices available | grep "iPhone"
        echo "=== Available iOS Versions ==="
        xcrun simctl list runtimes | grep "iOS"
        
    - name: Generate Xcode Project
      run: |
        xcodegen generate
        ls -la *.xcodeproj
        
    - name: Build iOS App
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.5' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   build \
                   -verbose
                   
    - name: Run Unit Tests
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.5' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   test \
                   -only-testing:BabyStepsTests \
                   -verbose
                   
    - name: Run UI Tests with Screenshots
      run: |
        # UIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=18.5' \
                   -derivedDataPath build \
                   -configuration Debug \
                   CODE_SIGN_STYLE=Automatic \
                   test \
                   -only-testing:BabyStepsUITests \
                   -resultBundlePath build/UITestResults.xcresult \
                   -verbose
        
        # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æŠ½å‡º
        mkdir -p screenshots
        xcrun xccov view --report --files --json build/UITestResults.xcresult > build/test-report.json || true
        
        # ãƒ†ã‚¹ãƒˆçµæœã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
        find build -name "*.png" -exec cp {} screenshots/ \; || true
        
    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-screenshots
        path: screenshots/
        retention-days: 30
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/UITestResults.xcresult
        retention-days: 30
                   
    - name: Archive App
      run: |
        xcodebuild -project BabySteps.xcodeproj \
                   -scheme BabySteps \
                   -destination 'generic/platform=iOS' \
                   -derivedDataPath build \
                   -configuration Release \
                   CODE_SIGN_STYLE=Automatic \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   archive -archivePath build/BabySteps.xcarchive
                   
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-artifacts
        path: build/
        retention-days: 7
        
    - name: Comment PR with Screenshots
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
          const screenshotsDir = 'screenshots';
          if (!fs.existsSync(screenshotsDir)) {
            console.log('Screenshots directory not found');
            return;
          }
          
          const files = fs.readdirSync(screenshotsDir);
          const imageFiles = files.filter(file => 
            file.endsWith('.png') || file.endsWith('.jpg') || file.endsWith('.jpeg')
          );
          
          if (imageFiles.length === 0) {
            console.log('No screenshot files found');
            return;
          }
          
          // PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          const comment = `## ğŸ–¼ï¸ UI Test Screenshots
          
          UIãƒ†ã‚¹ãƒˆã§æ’®å½±ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ã™ï¼š
          
          ${imageFiles.map(file => `- \`${file}\``).join('\n')}
          
          > ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ã€ŒActionsã€ã‚¿ãƒ–ã®ã€Œui-test-screenshotsã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
          
          ### ãƒ†ã‚¹ãƒˆçµæœ
          - âœ… ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ«ã€ŒBabyStepsã€ã®è¡¨ç¤ºç¢ºèª
          - âœ… ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã€ŒHello, iOS!ã€ã®è¡¨ç¤ºç¢ºèª  
          - âœ… ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºç¢ºèª
          - âœ… ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®é…ç½®ç¢ºèª
          - âœ… ç”»é¢å‘ãï¼ˆç¸¦å‘ãï¼‰ã®ç¢ºèª
          - âœ… ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¦ç´ ã®ç¢ºèª`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
          console.log('PR comment added successfully');