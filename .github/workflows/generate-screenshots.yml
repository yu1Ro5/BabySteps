name: Generate App Store Screenshots

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  screenshots:
    runs-on: macos-26
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 26.0
        run: |
          # Xcode 26.0ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
          if [ -d "/Applications/Xcode_26.0.app" ]; then
            sudo xcode-select -switch /Applications/Xcode_26.0.app
            echo "âœ… Xcode 26.0 selected"
          else
            echo "âŒ Xcode 26.0 not found"
            exit 1
          fi

      - name: Show Xcode and SDK info
        run: |
          echo "=== Xcode Version ==="
          xcodebuild -version
          echo "=== Available SDKs ==="
          xcodebuild -showsdks
          echo "=== Available Simulators ==="
          xcrun simctl list devices available | grep -E "(iPhone|iPad)" || echo "No simulators found"

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: |
          xcodegen generate
          ls -la *.xcodeproj

      - name: Check available iOS runtimes
        run: |
          echo "=== Available iOS Runtimes ==="
          xcrun simctl list runtimes | grep "iOS" || echo "No iOS runtimes found"

          # iOS 26.0ã‚’å›ºå®šã§ä½¿ç”¨
          export IOS_VERSION="26.0"
          echo "Using iOS version: $IOS_VERSION"

      - name: Setup simulators
        run: |
          echo "Using iOS version: $IOS_VERSION"

          # åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’ç¢ºèª
          echo "=== Available iPhone Simulators ==="
          xcrun simctl list devices available | grep "iPhone" | grep "26.0" || echo "No iPhone simulators found for iOS 26.0"

          echo "=== Available iPad Simulators ==="
          xcrun simctl list devices available | grep "iPad" | grep "26.0" || echo "No iPad simulators found for iOS 26.0"

      - name: Build app for iPhone
        run: |
          echo "Building for iPhone simulator with iOS $IOS_VERSION..."
          xcodebuild -project BabySteps.xcodeproj \
            -scheme BabySteps \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro Max,OS=26.0' \
            -derivedDataPath build \
            -configuration Debug \
            CODE_SIGN_STYLE=Automatic \
            CODE_SIGNING_ALLOWED=NO \
            build \
            -quiet

      - name: Create screenshots directory
        run: mkdir -p screenshots

      - name: Generate iPhone screenshot
        run: |
          echo "Generating iPhone screenshot..."

          # iPhone 17 Pro Maxã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•
          xcrun simctl boot "iPhone 17 Pro Max" || echo "iPhone simulator already booted"

          # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒå®Œå…¨ã«èµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          echo "Waiting for iPhone simulator to fully boot..."
          sleep 10

          # ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          xcrun simctl install booted "build/Build/Products/Debug-iphonesimulator/BabySteps.app"

          # ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
          xcrun simctl launch booted com.yu1Ro5.BabySteps

          # ã‚¢ãƒ—ãƒªãŒå®Œå…¨ã«èµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          echo "Waiting for app to fully launch..."
          sleep 8

          # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±
          xcrun simctl io booted screenshot "screenshots/iphone_6.5inch.png"

          echo "âœ… iPhone screenshot saved: screenshots/iphone_6.5inch.png"

      - name: Build app for iPad
        run: |
          echo "Building for iPad simulator with iOS $IOS_VERSION..."
          xcodebuild -project BabySteps.xcodeproj \
            -scheme BabySteps \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPad Pro 13-inch (M4),OS=26.0' \
            -derivedDataPath build \
            -configuration Debug \
            CODE_SIGN_STYLE=Automatic \
            CODE_SIGNING_ALLOWED=NO \
            build \
            -quiet

      - name: Generate iPad screenshot
        run: |
          echo "Generating iPad screenshot..."

          # ã™ã¹ã¦ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³
          xcrun simctl shutdown all

          # iPad Pro 13-inch (M4)ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’èµ·å‹•
          xcrun simctl boot "iPad Pro 13-inch (M4)" || echo "iPad simulator already booted"

          # iPadã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒå®Œå…¨ã«èµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆé•·ã‚ã«è¨­å®šï¼‰
          echo "Waiting for iPad simulator to fully boot..."
          sleep 25

          # ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          xcrun simctl install booted "build/Build/Products/Debug-iphonesimulator/BabySteps.app"

          # ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
          xcrun simctl launch booted com.yu1Ro5.BabySteps

          # iPadã‚¢ãƒ—ãƒªãŒå®Œå…¨ã«èµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆé•·ã‚ã«è¨­å®šï¼‰
          echo "Waiting for iPad app to fully launch..."
          sleep 18

          # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±
          xcrun simctl io booted screenshot "screenshots/ipad_13inch.png"

          echo "âœ… iPad screenshot saved: screenshots/ipad_13inch.png"

      - name: Verify screenshots
        run: |
          echo "=== Screenshot Verification ==="
          ls -la screenshots/

          if [ -f "screenshots/iphone_6.5inch.png" ]; then
            echo "âœ… iPhone screenshot exists"
            file "screenshots/iphone_6.5inch.png"
          else
            echo "âŒ iPhone screenshot missing"
            exit 1
          fi

          if [ -f "screenshots/ipad_13inch.png" ]; then
            echo "âœ… iPad screenshot exists"
            file "screenshots/ipad_13inch.png"
          else
            echo "âŒ iPad screenshot missing"
            exit 1
          fi

      - name: Upload screenshots artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-store-screenshots
          path: screenshots/
          retention-days: 30

      - name: Cleanup simulators
        if: always()
        run: |
          echo "Cleaning up simulators..."
          xcrun simctl shutdown all || true

      - name: Summary
        run: |
          echo "=== Screenshot Generation Summary ==="
          echo "âœ… iPhone 6.5-inch screenshot: screenshots/iphone_6.5inch.png"
          echo "âœ… iPad 13-inch screenshot: screenshots/ipad_13inch.png"
          echo "ğŸ“± iOS version used: $IOS_VERSION"
          echo "ğŸ”§ XcodeGen project generated successfully"
          echo "ğŸ“¦ Screenshots uploaded as artifact: app-store-screenshots"